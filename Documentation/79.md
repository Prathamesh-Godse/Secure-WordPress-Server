
# NGINX Configuration for WP Super Cache Exclusions

## Purpose

To configure NGINX to bypass or serve cached files generated by the WP Super Cache WordPress plugin, ensuring dynamic content and sensitive areas are excluded from caching while improving performance by serving cached pages to eligible visitors.

## Structured Document

### Step 1: Create the WP Super Cache Exclusion File

Navigate to the NGINX includes directory and create the exclusion configuration file:

```bash
cd /etc/nginx/includes
sudo nano wp_super_cache_excludes.conf
```

---

### Step 2: Define Cache Exclusion and Serving Rules

Paste the following content into the file:

```nginx
# WP Super Cache NGINX Cache Exclusions Rules.
set $cache_uri $request_uri;

# POST requests and URLs with query strings should bypass cache
if ($request_method = POST) {
	set $cache_uri 'null cache';
}
if ($query_string != "") {
    set $cache_uri 'null cache';
}

# Skip cache for admin, login, sitemaps, feeds, special WP paths
if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php|wp-.*.php|/feed/|index.php|wp-comments-popup.php|wp-links-opml.php|wp-locations.php|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
    set $cache_uri 'null cache';
}

# Skip cache for logged-in users and commenters
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_logged_in") {
    set $cache_uri 'null cache';
}

# Serve cache if it exists, fallback to PHP
location / {
    try_files /wp-content/cache/supercache/$http_host/$cache_uri/index-https.html $uri $uri/ /index.php?$args;
}
```

---

### Explanation of Key Directives

| Directive                      | Explanation                                                                                        |
| ------------------------------ | -------------------------------------------------------------------------------------------------- |
| `set $cache_uri $request_uri;` | Defines the default cache key based on the requested URI.                                          |
| `if ($request_method = POST)`  | Ensures POST requests bypass cache to allow dynamic data submission.                               |
| `if ($query_string != "")`     | Prevents caching URLs with query parameters, which typically generate dynamic or filtered content. |
| `if ($request_uri ~* "...")`   | Excludes admin pages, login, feeds, sitemaps, and other sensitive WordPress paths from caching.    |
| `if ($http_cookie ~* "...")`   | Bypasses cache for logged-in users and recent commenters, identified via cookies.                  |
| `location / { try_files ... }` | Attempts to serve the cached file if present, falling back to normal processing if not cached.     |

---

### Usage Instructions

1. Include this file in your NGINX site configuration:

```nginx
include /etc/nginx/includes/wp_super_cache_excludes.conf;
```

2. Place this include directive **outside any existing `location` blocks**, or replace the existing `location /` block if necessary.

3. Reload NGINX to apply changes:

```bash
sudo systemctl reload nginx
```

---

## Best Practices

* Confirm that the cache directory structure matches WP Super Cacheâ€™s output location.
* Regularly monitor cache hit rates and error logs to identify caching issues.
* Exclude sensitive or user-specific content to avoid serving stale or incorrect pages.
* Keep the exclusion rules up to date with any changes in WordPress paths or plugin behavior.
